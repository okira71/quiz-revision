<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Litt√©raires Avanc√©</title>
<style>
    /* Th√®me Clair (par d√©faut) */
    :root {
        --bg-color: #f0f0f0;
        --text-color: #333;
        --header-color: #222;
        --phrase-color: #555;
        --select-bg: #fff;
        --select-border: #c0c0c0;
        --button-primary-bg: #0078d4;
        --button-primary-hover: #005a9e;
        --button-secondary-bg: #6c757d;
        --button-secondary-hover: #5a6268;
        --feedback-correct: #28a745;
        --feedback-incorrect: #dc3545;
        --container-bg: #ffffff;
        --progress-bg: #e0e0e0;
        --progress-fill: #4CAF50;
        --input-bg: #fff;
        --input-border: #ccc;
    }

    /* Th√®me Sombre */
    .dark-mode {
        --bg-color: #121212;
        --text-color: #f0f0f0;
        --header-color: #ffffff;
        --phrase-color: #cccccc;
        --select-bg: #333333;
        --select-border: #666666;
        --container-bg: #1e1e1e;
        --progress-bg: #333;
        --progress-fill: #66BB6A;
        --input-bg: #222;
        --input-border: #555;
    }

    body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
        transition: background 0.3s, color 0.3s;
    }

    .header-container {
        width: 100%;
        max-width: 580px;
        display: flex;
        justify-content: space-between; /* Pour espacer les √©l√©ments */
        align-items: center;
        padding: 0 10px;
        margin-bottom: 20px;
    }
    
    #themeToggleBtn {
        background: var(--button-secondary-bg);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
    }

    #currentUserDisplay {
        font-size: 0.9em;
        color: var(--phrase-color);
    }

    .main-content {
        max-width: 580px;
        width: 100%;
        text-align: center;
    }

    #quizTitle {
        font-size: 2.5em;
        margin-bottom: 5px;
        color: var(--header-color);
    }

    #highScoreDisplay {
        font-size: 1.1em;
        color: var(--phrase-color);
        margin-bottom: 15px;
        min-height: 20px;
    }
    #timerDisplay {
        font-size: 1.2em;
        font-weight: bold;
        color: var(--feedback-incorrect);
        margin-bottom: 10px;
        min-height: 20px;
    }

    /* --- Styles du Menu de S√©lection --- */
    #selectionContainer h1 {
        font-size: 2.8em;
        color: var(--header-color);
        margin-bottom: 30px;
    }

    .menu-section {
        background: var(--container-bg);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        text-align: left;
    }
    .menu-section h2 {
        color: var(--header-color);
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.6em;
        border-bottom: 1px solid var(--select-border);
        padding-bottom: 10px;
    }
    .menu-section label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: var(--text-color);
    }
    .menu-section input[type="text"],
    .menu-section select {
        width: calc(100% - 20px);
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid var(--input-border);
        border-radius: 4px;
        background-color: var(--input-bg);
        color: var(--text-color);
        font-size: 1em;
    }
    .menu-section button {
        margin-top: 10px;
        width: auto;
        padding: 10px 20px;
    }
    .menu-section .profile-list button {
        display: inline-block;
        margin-right: 10px;
        margin-bottom: 10px;
        max-width: fit-content;
        background: var(--button-secondary-bg);
    }
    .menu-section .profile-list button:hover {
        background: var(--button-secondary-hover);
    }

    .quiz-choice-btn {
        font-size: 1.3em;
        padding: 15px 25px;
        width: 100%;
        max-width: 400px;
        margin-top: 15px;
        margin-bottom: 15px;
    }
    .quiz-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }
    .quiz-options button {
        flex: 1;
        min-width: 120px;
        padding: 10px 15px;
        font-size: 0.9em;
        background-color: var(--button-secondary-bg);
    }
    .quiz-options button.selected {
        background-color: var(--button-primary-bg);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }


    /* --- Styles du Quiz --- */
    .progress-bar-container {
        width: 100%;
        background-color: var(--progress-bg);
        border-radius: 5px;
        margin-bottom: 25px;
        height: 10px;
        overflow: hidden; /* Ensure fill doesn't overflow */
    }

    .progress-bar-fill {
        height: 100%;
        width: 0%;
        background-color: var(--progress-fill);
        border-radius: 5px;
        transition: width 0.3s ease-in-out;
    }

    .phrase {
        font-style: italic;
        font-size: 1.5em;
        margin: 30px 0 25px 0;
        line-height: 1.5;
        color: var(--phrase-color);
        padding: 15px;
        background: var(--bg-color);
        border-radius: 8px;
    }

    select {
        width: 100%;
        padding: 12px 15px;
        font-size: 1.1em;
        margin-bottom: 25px;
        border: 1px solid var(--select-border);
        border-radius: 4px;
        background-color: var(--select-bg);
        color: var(--text-color);
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%204%205%22%3E%3Cpath%20fill%3D%22%23cccccc%22%20d%3D%22M2%200L0%202h4L2%200zM2%205L0%203h4L2%205z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 8px 10px;
        cursor: pointer;
    }

    button {
        padding: 12px 28px;
        font-size: 1.15em;
        background: var(--button-primary-bg);
        border: none;
        color: white;
        cursor: pointer;
        width: 100%;
        max-width: 350px;
        border-radius: 4px;
        transition: background 0.2s ease;
        margin: 10px auto;
        display: block;
    }
    button:hover { background: var(--button-primary-hover); }

    #explanationBtn, #backToMenuBtn { background: var(--button-secondary-bg); }
    #explanationBtn:hover, #backToMenuBtn:hover { background: var(--button-secondary-hover); }
    
    .feedback {
        margin-top: 30px;
        font-weight: bold;
        min-height: 80px;
        font-size: 1.25em;
        line-height: 1.5;
        white-space: pre-wrap; /* Pour afficher les retours √† la ligne */
    }
    .feedback.correct { color: var(--feedback-correct); }
    .feedback.incorrect { color: var(--feedback-incorrect); }

    .score { margin-top: 35px; font-size: 1.3em; color: var(--phrase-color); }
    #quizContainer { display: none; width: 100%; }
    #statsContainer { display: none; width: 100%; }
    #statsContainer h2 {
        color: var(--header-color);
        font-size: 2em;
        margin-bottom: 20px;
    }
    #statsDetails p {
        font-size: 1.1em;
        margin-bottom: 10px;
    }
    #statsDetails ul {
        list-style: none;
        padding: 0;
        margin-top: 20px;
    }
    #statsDetails ul li {
        background: var(--container-bg);
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .stat-correct { color: var(--feedback-correct); font-weight: bold; }
    .stat-incorrect { color: var(--feedback-incorrect); font-weight: bold; }

</style>
</head>
<body>

<div class="header-container">
    <span id="currentUserDisplay"></span>
    <button id="themeToggleBtn">Th√®me Sombre</button>
</div>

<div class="main-content">
    <div id="selectionContainer">
        <h1>Quiz Litt√©raires</h1>

        <div class="menu-section">
            <h2>G√©rer les Profils</h2>
            <label for="usernameInput">Nom d'utilisateur :</label>
            <input type="text" id="usernameInput" placeholder="Entrez votre nom" />
            <button id="createUserBtn">Cr√©er Nouveau Profil</button>
            <button id="loadUserBtn">Charger Profil</button>
            <div id="profileList" class="profile-list" style="margin-top: 15px;">
                <!-- Les profils charg√©s seront ins√©r√©s ici -->
            </div>
            <p style="font-size: 0.9em; margin-top: 15px;">Profil actif : <strong id="activeUserProfile">Aucun</strong></p>
            <button id="viewStatsBtn" style="display: none;">Voir mes Statistiques</button>
        </div>

        <div class="menu-section">
            <h2>Choisir un Quiz</h2>
            <button id="startFiguresBtn" class="quiz-choice-btn">üß† Figures de Style</button>
            <button id="startTonalitesBtn" class="quiz-choice-btn">üìò Tonalit√©s Litt√©raires</button>
        </div>

        <div class="menu-section" id="gameOptionsSection" style="display: none;">
            <h2>Options de Jeu</h2>
            <label>Mode de Jeu :</label>
            <div class="quiz-options" id="gameModeOptions">
                <button data-mode="normal" class="selected">Normal</button>
                <button data-mode="survival">Survie</button>
                <button data-mode="timetrial">Contre-la-montre</button>
                <button data-mode="revision">R√©vision</button>
            </div>

            <label for="difficultySelect" style="margin-top: 15px;">Difficult√© :</label>
            <div class="quiz-options" id="difficultyOptions">
                <button data-difficulty="any" class="selected">Al√©atoire</button>
                <button data-difficulty="easy">Facile</button>
                <button data-difficulty="medium">Moyen</button>
                <button data-difficulty="hard">Difficile</button>
            </div>
            
            <button id="startSelectedQuizBtn" style="margin-top: 20px;">D√©marrer le Quiz</button>
        </div>
    </div>

    <div id="quizContainer">
        <h1 id="quizTitle"></h1>
        <div id="highScoreDisplay"></div>
        <div id="timerDisplay"></div> <!-- Nouveau : Affichage du timer -->
        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>
        <div class="phrase" id="phrase"></div>
        <form id="form">
            <label for="answer" style="display: none;">R√©ponse :</label><br>
            <select id="answer" required></select><br>
            <button type="submit" id="submitBtn">Valider</button>
        </form>
        <div id="feedback" class="feedback"></div>
        <div id="score" class="score"></div>
        <button id="explanationBtn" style="display: none;">Voir l'explication</button>
        <button id="nextBtn" style="display: none;">Suivant</button>
        <div id="endQuizBtns" style="display: none;">
            <button id="replayBtn">Rejouer</button>
            <button id="backToMenuBtn">Retour au Menu</button>
            <button id="viewQuizStatsBtn">Statistiques du Quiz</button> <!-- Nouveau bouton pour stats du quiz termin√© -->
        </div>
    </div>

    <div id="statsContainer">
        <h2>Statistiques de <span id="statsUserName"></span></h2>
        <div id="statsDetails">
            <!-- Les statistiques d√©taill√©es seront ins√©r√©es ici -->
            <p>Score total le plus √©lev√© pour <span id="statsForQuizTitle"></span>: <span id="statsHighScore"></span></p>
            <h3>Performance par Question (top 5 des plus rat√©es) :</h3>
            <ul id="failedQuestionsList"></ul>
        </div>
        <button id="backToMainMenuFromStatsBtn">Retour au Menu Principal</button>
    </div>
</div>

<script>
    // --- GESTION DES √âL√âMENTS DU DOM ---
    const selectionContainer = document.getElementById('selectionContainer');
    const quizContainer = document.getElementById('quizContainer');
    const statsContainer = document.getElementById('statsContainer');

    const usernameInput = document.getElementById('usernameInput');
    const createUserBtn = document.getElementById('createUserBtn');
    const loadUserBtn = document.getElementById('loadUserBtn');
    const profileList = document.getElementById('profileList');
    const activeUserProfileDisplay = document.getElementById('activeUserProfile');
    const currentUserDisplay = document.getElementById('currentUserDisplay'); // En-t√™te global
    const viewStatsBtn = document.getElementById('viewStatsBtn');

    const startFiguresBtn = document.getElementById('startFiguresBtn');
    const startTonalitesBtn = document.getElementById('startTonalitesBtn');
    const gameOptionsSection = document.getElementById('gameOptionsSection');
    const gameModeOptions = document.getElementById('gameModeOptions');
    const difficultyOptions = document.getElementById('difficultyOptions');
    const startSelectedQuizBtn = document.getElementById('startSelectedQuizBtn');
    
    const quizTitleEl = document.getElementById('quizTitle');
    const highScoreDisplay = document.getElementById('highScoreDisplay');
    const timerDisplay = document.getElementById('timerDisplay'); // Nouveau : Affichage du timer
    const progressBarFill = document.getElementById('progressBarFill');
    const phraseEl = document.getElementById('phrase');
    const form = document.getElementById('form');
    const answerSelect = document.getElementById('answer');
    const feedbackEl = document.getElementById('feedback');
    const scoreEl = document.getElementById('score');
    
    const submitBtn = document.getElementById('submitBtn');
    const explanationBtn = document.getElementById('explanationBtn');
    const nextBtn = document.getElementById('nextBtn');
    const endQuizBtns = document.getElementById('endQuizBtns');
    const replayBtn = document.getElementById('replayBtn');
    const backToMenuBtn = document.getElementById('backToMenuBtn');
    const viewQuizStatsBtn = document.getElementById('viewQuizStatsBtn'); // Bouton pour voir stats du quiz termin√©
    const backToMainMenuFromStatsBtn = document.getElementById('backToMainMenuFromStatsBtn');
    const themeToggleBtn = document.getElementById('themeToggleBtn');

    const statsUserName = document.getElementById('statsUserName');
    const statsForQuizTitle = document.getElementById('statsForQuizTitle');
    const statsHighScore = document.getElementById('statsHighScore');
    const failedQuestionsList = document.getElementById('failedQuestionsList');

    // --- VARIABLES GLOBALES DU QUIZ ET DU PROFIL ---
    // allQuizData will now contain mock data directly embedded for demonstration.
    // In a production environment, you would fetch these from actual JSON files.
    let allQuizData = {
        'figures': {
            quizId: 'figures',
            title: 'Figures de Style',
            defaultLength: 5,
            questions: [
                {
                    prompt: "L'allit√©ration est la r√©p√©tition de consonnes.",
                    answer: "Allit√©ration",
                    difficulty: "easy",
                    explication: "L'allit√©ration est une figure de style qui consiste en la r√©p√©tition d'un m√™me son consonantique dans une suite de mots."
                },
                {
                    prompt: "La r√©p√©tition d'une m√™me voyelle est une...",
                    answer: "Assonance",
                    difficulty: "easy",
                    explication: "L'assonance est la r√©p√©tition d'une m√™me voyelle dans une suite de mots."
                },
                {
                    prompt: "Figure de style o√π l'on att√©nue la r√©alit√©, pour adoucir une id√©e jug√©e trop brutale.",
                    answer: "Euph√©misme",
                    difficulty: "medium",
                    explication: "L'euph√©misme consiste √† employer un mot ou une expression moins forte que celle que l'on attendrait, afin d'att√©nuer le caract√®re d√©sagr√©able, brutal ou choquant de la r√©alit√©."
                },
                {
                    prompt: "Expression qui utilise un mot dans un sens figur√© par analogie, sans outil de comparaison.",
                    answer: "M√©taphore",
                    difficulty: "medium",
                    explication: "La m√©taphore est une figure de style consistant √† rapprocher deux √©l√©ments sans utiliser de mot de comparaison explicite (comme, tel, pareil √†, etc.)."
                },
                {
                    prompt: "Figure de style qui consiste √† dire le contraire de ce que l'on pense en employant un ton, un geste ou un contexte qui indique le v√©ritable sens.",
                    answer: "Ironie",
                    difficulty: "hard",
                    explication: "L'ironie est une figure de rh√©torique qui consiste √† affirmer le contraire de ce que l'on veut faire entendre, en s'appuyant sur l'implicite ou le non-dit pour que le destinataire comprenne le v√©ritable sens."
                },
                {
                    prompt: "R√©p√©tition d'un m√™me mot ou groupe de mots en d√©but de phrase.",
                    answer: "Anaphore",
                    difficulty: "easy",
                    explication: "L'anaphore est une figure de style qui consiste √† r√©p√©ter un m√™me mot ou groupe de mots en d√©but de phrase, de vers ou de proposition successive."
                },
                {
                    prompt: "Exag√©ration des traits d'une personne ou d'une chose pour produire un effet comique ou critique.",
                    answer: "Caricature",
                    difficulty: "medium",
                    explication: "La caricature est une d√©formation grotesque des traits caract√©ristiques d'une personne ou d'une chose pour produire un effet comique ou satirique."
                },
                {
                    prompt: "Consiste √† exprimer une id√©e par son contraire, en utilisant un ton ou une expression qui indique le vrai sens.",
                    answer: "Antiphrase",
                    difficulty: "hard",
                    explication: "L'antiphrase est une figure de style consistant √† exprimer une id√©e par son contraire dans une intention ironique, humoristique ou euph√©mique."
                }
            ]
        },
        'tonalites': {
            quizId: 'tonalites',
            title: 'Tonalit√©s Litt√©raires',
            defaultLength: 5,
            questions: [
                {
                    prompt: "Tonalit√© qui vise √† √©mouvoir le lecteur en suscitant la piti√© et la tristesse.",
                    answer: "Path√©tique",
                    difficulty: "easy",
                    explication: "La tonalit√© path√©tique cherche √† provoquer une forte √©motion chez le lecteur, en particulier la piti√© et la tristesse face √† la souffrance ou au malheur."
                },
                {
                    prompt: "Tonalit√© qui exprime un sentiment d'indignation et de r√©volte, souvent avec violence.",
                    answer: "Pol√©mique",
                    difficulty: "medium",
                    explication: "La tonalit√© pol√©mique se caract√©rise par l'expression d'un d√©saccord fort, d'une critique virulente, et vise √† provoquer le d√©bat."
                },
                {
                    prompt: "Tonalit√© qui cherche √† faire rire ou sourire, souvent par l'absurde ou la satire.",
                    answer: "Comique",
                    difficulty: "easy",
                    explication: "La tonalit√© comique utilise diverses techniques (mots, situations, caract√®res) pour amuser et d√©tendre le lecteur."
                },
                {
                    prompt: "Tonalit√© qui d√©forme la r√©alit√© pour la rendre grotesque et effrayante.",
                    answer: "Fantastique",
                    difficulty: "hard",
                    explication: "La tonalit√© fantastique plonge le lecteur dans l'incertitude face √† des √©v√©nements inexplicables, √† la fronti√®re entre le r√©el et le surnaturel."
                },
                {
                    prompt: "Tonalit√© qui exprime la joie, l'enthousiasme et la c√©l√©bration.",
                    answer: "Lyrique",
                    difficulty: "medium",
                    explication: "La tonalit√© lyrique est l'expression des sentiments personnels, souvent intenses, de l'auteur (amour, joie, tristesse, nostalgie)."
                },
                {
                    prompt: "Tonalit√© qui vise √† instruire, √† informer ou √† exposer des connaissances.",
                    answer: "Didactique",
                    difficulty: "easy",
                    explication: "La tonalit√© didactique a pour objectif d'enseigner et de transmettre un savoir, une morale, ou des principes."
                },
                {
                    prompt: "Tonalit√© qui met en sc√®ne des situations extr√™mes et des personnages aux passions violentes.",
                    answer: "Dramatique",
                    difficulty: "hard",
                    explication: "La tonalit√© dramatique est caract√©ristique des ≈ìuvres o√π les √©v√©nements s'encha√Ænent de mani√®re tendue, aboutissant souvent √† une crise ou un d√©nouement intense."
                }
            ]
        }
    }; 
    // allQuizData will now contain mock data directly embedded for demonstration.
    // In a production environment, you would fetch these from actual JSON files.
    // let allQuizData = {}; // Original declaration, now replaced.

    let currentQuizData = null; // Donn√©es du quiz actuellement s√©lectionn√©
    let questionsForThisQuiz = []; // Questions pour la session de quiz actuelle
    let currentQuestionIndex = 0;
    let score = 0;

    let activeUser = null; // L'objet du profil utilisateur actif
    let users = {}; // Tous les profils d'utilisateurs charg√©s depuis localStorage

    let selectedGameMode = 'normal';
    let selectedDifficulty = 'any';
    let quizTimer = null; // Pour le mode contre-la-montre
    const TIME_PER_QUESTION_SECONDS = 15; // Temps par question en mode contre-la-montre

    // --- POND√âRATION DES SCORES PAR DIFFICULT√â ---
    const DIFFICULTY_POINTS = {
        'easy': 1,
        'medium': 2,
        'hard': 3
    };

    // --- FONCTIONS DE GESTION DES PROFILS UTILISATEUR ---

    function loadUsers() {
        const storedUsers = localStorage.getItem('quizUsers');
        if (storedUsers) {
            users = JSON.parse(storedUsers);
            const activeUserId = localStorage.getItem('activeQuizUser');
            if (activeUserId && users[activeUserId]) {
                activeUser = users[activeUserId];
                updateActiveUserDisplay();
                viewStatsBtn.style.display = 'block';
            }
        }
        renderProfileList();
    }

    function saveUsers() {
        localStorage.setItem('quizUsers', JSON.stringify(users));
        if (activeUser) {
            localStorage.setItem('activeQuizUser', activeUser.id);
        } else {
            localStorage.removeItem('activeQuizUser');
        }
    }

    function createUser() {
        const username = usernameInput.value.trim();
        if (username.length < 3) {
            alert("Le nom d'utilisateur doit contenir au moins 3 caract√®res."); // Utiliser une modale custom dans une vraie app
            return;
        }
        if (users[username]) {
            alert("Ce nom d'utilisateur existe d√©j√†. Veuillez en choisir un autre ou le charger.");
            return;
        }

        const newUser = {
            id: username, // Pour la simplicit√©, l'ID est le nom d'utilisateur
            name: username,
            quizStats: {} // Stockera les performances de chaque quiz
        };
        users[username] = newUser;
        activeUser = newUser;
        saveUsers();
        updateActiveUserDisplay();
        alert(`Profil '${username}' cr√©√© et s√©lectionn√© !`);
        viewStatsBtn.style.display = 'block';
    }

    function loadUser(username) {
        if (!users[username]) {
            alert("Profil non trouv√©.");
            return;
        }
        activeUser = users[username];
        saveUsers();
        updateActiveUserDisplay();
        alert(`Profil '${username}' charg√© !`);
        viewStatsBtn.style.display = 'block';
    }

    function updateActiveUserDisplay() {
        if (activeUser) {
            activeUserProfileDisplay.textContent = activeUser.name;
            currentUserDisplay.textContent = `Bienvenue, ${activeUser.name} !`;
        } else {
            activeUserProfileDisplay.textContent = 'Aucun';
            currentUserDisplay.textContent = '';
        }
    }

    function renderProfileList() {
        profileList.innerHTML = '';
        for (const userId in users) {
            const userBtn = document.createElement('button');
            userBtn.textContent = users[userId].name;
            userBtn.addEventListener('click', () => loadUser(userId));
            profileList.appendChild(userBtn);
        }
    }

    // --- FONCTIONS DE GESTION DES QUIZ (Chargement & S√©lection) ---

    // Removed the fetchAllQuizData function as data is now directly embedded.
    /*
    async function fetchAllQuizData() {
        const quizFiles = {
            'figures': 'quiz-figures.json',
            'tonalites': 'quiz-tonalites.json'
        };

        for (const quizId in quizFiles) {
            try {
                const response = await fetch(quizFiles[quizId]);
                if (!response.ok) {
                    throw new Error(`Erreur de chargement du quiz ${quizId}: ${response.statusText}`);
                }
                const data = await response.json();
                allQuizData[quizId] = data;
            } catch (error) {
                console.error(`Impossible de charger les donn√©es du quiz ${quizId}:`, error);
                alert(`Une erreur est survenue lors du chargement du quiz '${quizId}'.`); // Utiliser une modale custom
            }
        }
    }
    */

    function selectQuiz(quizId) {
        if (!activeUser) {
            alert("Veuillez cr√©er ou charger un profil utilisateur avant de choisir un quiz.");
            return;
        }
        currentQuizData = allQuizData[quizId];
        if (currentQuizData) {
            // Afficher les options de jeu
            gameOptionsSection.style.display = 'block';
            // Mettre √† jour l'affichage du meilleur score pour le quiz s√©lectionn√©
            loadHighScore();
        }
    }

    // --- LOGIQUE DU HIGH SCORE ET STATS UTILISATEUR ---

    function getQuizStatsForCurrentUser(quizId) {
        if (!activeUser) return null;
        if (!activeUser.quizStats[quizId]) {
            activeUser.quizStats[quizId] = {
                highScore: 0,
                totalPlayed: 0,
                totalCorrect: 0,
                totalQuestionsAnswered: 0,
                questionPerformance: {} // { "prompt_hash": { correct: X, incorrect: Y } }
            };
        }
        return activeUser.quizStats[quizId];
    }

    function loadHighScore() {
        if (!currentQuizData || !activeUser) {
            highScoreDisplay.textContent = '';
            return;
        }
        const stats = getQuizStatsForCurrentUser(currentQuizData.quizId);
        const quizLength = currentQuizData.defaultLength || currentQuizData.questions.length;
        highScoreDisplay.textContent = `üèÜ Record (${activeUser.name}) : ${stats.highScore} / ${quizLength}`;
    }

    function saveQuizStats(quizId, finalScore, totalQuestionsPlayed, questionResults) {
        if (!activeUser) return;
        const stats = getQuizStatsForCurrentUser(quizId);
        
        stats.totalPlayed++;
        stats.totalCorrect += finalScore;
        stats.totalQuestionsAnswered += totalQuestionsPlayed;

        // Mise √† jour du meilleur score
        if (finalScore > stats.highScore) {
            stats.highScore = finalScore;
            // Retourne vrai si c'est un nouveau record
        }

        // Mise √† jour des performances par question
        for (const promptHash in questionResults) {
            if (!stats.questionPerformance[promptHash]) {
                stats.questionPerformance[promptHash] = { correct: 0, incorrect: 0 };
            }
            if (questionResults[promptHash] === 'correct') {
                stats.questionPerformance[promptHash].correct++;
            } else {
                stats.questionPerformance[promptHash].incorrect++;
            }
        }
        saveUsers(); // Sauvegarde tout l'objet users
    }

    function displayOverallStats() {
        if (!activeUser) {
            alert("Veuillez charger un profil pour voir les statistiques.");
            return;
        }
        selectionContainer.style.display = 'none';
        quizContainer.style.display = 'none';
        statsContainer.style.display = 'block';

        statsUserName.textContent = activeUser.name;
        statsForQuizTitle.textContent = "tous les quiz"; // Afficher les stats g√©n√©rales

        // Calculer les stats globales (exemple)
        let totalHighScoreSum = 0;
        let totalQuizzesPlayed = 0;
        let mostFailedQuestions = {}; // { prompt: { correct: X, incorrect: Y, quizId: Z } }

        for (const quizId in activeUser.quizStats) {
            const stats = activeUser.quizStats[quizId];
            totalHighScoreSum += stats.highScore;
            totalQuizzesPlayed += stats.totalPlayed;

            for (const promptHash in stats.questionPerformance) {
                const qPerf = stats.questionPerformance[promptHash];
                const questionData = findQuestionByHash(quizId, promptHash); // Fonction utilitaire √† cr√©er
                if (questionData) {
                    const prompt = questionData.prompt;
                    if (!mostFailedQuestions[prompt]) {
                        mostFailedQuestions[prompt] = { correct: 0, incorrect: 0 };
                    }
                    mostFailedQuestions[prompt].correct += qPerf.correct;
                    mostFailedQuestions[prompt].incorrect += qPerf.incorrect;
                }
            }
        }

        statsHighScore.textContent = `${totalHighScoreSum} points (sur les meilleurs scores cumul√©s)`;
        // Afficher les questions les plus rat√©es
        const sortedFailedQuestions = Object.entries(mostFailedQuestions)
            .filter(([, data]) => data.incorrect > data.correct) // Filtrer celles o√π incorrect > correct
            .sort((a, b) => (b[1].incorrect - b[1].correct) - (a[1].incorrect - a[1].correct)) // Trier par diff√©rence
            .slice(0, 5); // Top 5

        failedQuestionsList.innerHTML = '';
        if (sortedFailedQuestions.length > 0) {
            sortedFailedQuestions.forEach(([prompt, data]) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>"${prompt}"</strong> <br> (Correct: <span class="stat-correct">${data.correct}</span>, Incorrect: <span class="stat-incorrect">${data.incorrect}</span>)`;
                failedQuestionsList.appendChild(li);
            });
        } else {
            failedQuestionsList.innerHTML = '<li>Aucune question n\'a √©t√© rat√©e plus d\'une fois. Continuez comme √ßa !</li>';
        }
    }

    // Utility to find question data by hash (for stats display)
    function findQuestionByHash(quizId, promptHash) {
        const quiz = allQuizData[quizId];
        if (quiz) {
            return quiz.questions.find(q => stringToHash(q.prompt) === promptHash);
        }
        return null;
    }


    // --- LOGIQUE DU QUIZ (G√©n√©rique) ---

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function populateSelectOptions() {
        answerSelect.innerHTML = '<option value="" disabled selected>Choisis une r√©ponse</option>';
        const answers = currentQuizData.questions.map(q => q.answer);
        const uniqueAnswers = [...new Set(answers)].sort();
        uniqueAnswers.forEach(answer => {
            const option = document.createElement('option');
            option.value = answer;
            option.textContent = answer.charAt(0).toUpperCase() + answer.slice(1);
            answerSelect.appendChild(option);
        });
    }

    function stringToHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0; // Convert to 32bit integer
        }
        return hash.toString();
    }

    function showMenu() {
        selectionContainer.style.display = 'block';
        quizContainer.style.display = 'none';
        statsContainer.style.display = 'none';
        gameOptionsSection.style.display = 'none'; // Hide game options when returning to main menu
        // Reset selected game mode and difficulty to defaults for next selection
        selectedGameMode = 'normal';
        selectedDifficulty = 'any';
        Array.from(gameModeOptions.children).forEach(btn => {
            btn.classList.remove('selected');
            if (btn.dataset.mode === 'normal') btn.classList.add('selected');
        });
        Array.from(difficultyOptions.children).forEach(btn => {
            btn.classList.remove('selected');
            if (btn.dataset.difficulty === 'any') btn.classList.add('selected');
        });
    }

    function startQuiz() {
        if (!currentQuizData) {
            alert("Veuillez s√©lectionner un quiz.");
            return;
        }
        if (!activeUser) {
            alert("Veuillez cr√©er ou charger un profil utilisateur.");
            return;
        }

        // Filtration des questions par difficult√©
        let availableQuestions = [...currentQuizData.questions];
        if (selectedDifficulty !== 'any') {
            availableQuestions = availableQuestions.filter(q => q.difficulty === selectedDifficulty);
        }

        // Logique du mode R√©vision (pour plus tard)
        if (selectedGameMode === 'revision') {
            const stats = getQuizStatsForCurrentUser(currentQuizData.quizId);
            const failedQuestionHashes = Object.keys(stats.questionPerformance).filter(hash => 
                stats.questionPerformance[hash].incorrect > stats.questionPerformance[hash].correct
            );
            if (failedQuestionHashes.length > 0) {
                // Cr√©er un tableau de questions bas√©es sur les hachages des questions rat√©es
                questionsForThisQuiz = failedQuestionHashes.map(hash => 
                    availableQuestions.find(q => stringToHash(q.prompt) === hash)
                ).filter(q => q !== undefined); // Filtrer les undefined si une question n'est plus trouv√©e
                
                // If revision questions are filtered by difficulty, ensure they match
                if (selectedDifficulty !== 'any') {
                    questionsForThisQuiz = questionsForThisQuiz.filter(q => q.difficulty === selectedDifficulty);
                }
                
                if (questionsForThisQuiz.length === 0) {
                     alert("Pas de questions √† r√©viser avec la difficult√© s√©lectionn√©e, ou toutes les questions rat√©es ont √©t√© ma√Ætris√©es !");
                     showMenu();
                     return;
                }
            } else {
                alert("Vous n'avez pas encore de questions √† r√©viser pour ce quiz.");
                showMenu();
                return;
            }
        } else {
            // Pour les autres modes, m√©langer et prendre le nombre par d√©faut ou toutes
            shuffleArray(availableQuestions);
            const quizLength = currentQuizData.defaultLength ? 
                               Math.min(currentQuizData.defaultLength, availableQuestions.length) :
                               availableQuestions.length;
            questionsForThisQuiz = availableQuestions.slice(0, quizLength);
        }

        if (questionsForThisQuiz.length === 0) {
            alert("Aucune question ne correspond √† vos crit√®res de s√©lection (difficult√©, etc.) pour ce quiz.");
            showMenu();
            return;
        }

        selectionContainer.style.display = 'none';
        quizContainer.style.display = 'block';
        quizTitleEl.textContent = currentQuizData.title;
        loadHighScore();
        timerDisplay.style.display = 'none'; // Cacher par d√©faut

        currentQuestionIndex = 0;
        score = 0;
        
        populateSelectOptions();
        updateQuestion();

        // D√©marrer le timer si en mode contre-la-montre
        if (selectedGameMode === 'timetrial') {
            startTimer();
            timerDisplay.style.display = 'block';
        } else {
            stopTimer(); // S'assurer que le timer est arr√™t√© si non en mode contre-la-montre
        }
    }
    
    function updateQuestion() {
        endQuizBtns.style.display = 'none';
        nextBtn.style.display = 'none';
        explanationBtn.style.display = 'none';

        if (currentQuestionIndex >= questionsForThisQuiz.length) {
            endQuiz();
            return;
        }

        const currentQuestion = questionsForThisQuiz[currentQuestionIndex];
        phraseEl.textContent = currentQuestion.prompt;
        answerSelect.value = "";
        feedbackEl.innerHTML = "";
        feedbackEl.className = 'feedback';
        scoreEl.textContent = `Score : ${score} / ${currentQuestionIndex} (Q. ${currentQuestionIndex + 1}/${questionsForThisQuiz.length})`;
        form.style.display = "block";
        submitBtn.style.display = "block";
        submitBtn.disabled = false;

        // Met √† jour la barre de progression
        const progress = (currentQuestionIndex / questionsForThisQuiz.length) * 100;
        progressBarFill.style.width = `${progress}%`;

        // R√©initialiser le timer pour la nouvelle question si en mode contre-la-montre
        if (selectedGameMode === 'timetrial') {
            resetTimerForQuestion();
        }
    }

    let questionTimer = null;
    let timeLeftForQuestion = TIME_PER_QUESTION_SECONDS;

    function startTimer() {
        resetTimerForQuestion(); // D√©marre le timer pour la premi√®re question
        // Le timer principal g√®re l'affichage du temps restant pour la question actuelle
        // Pas besoin de timer global pour le quiz entier pour l'instant.
    }

    function resetTimerForQuestion() {
        clearInterval(questionTimer);
        timeLeftForQuestion = TIME_PER_QUESTION_SECONDS;
        timerDisplay.textContent = `Temps restant : ${timeLeftForQuestion}s`;
        questionTimer = setInterval(() => {
            timeLeftForQuestion--;
            timerDisplay.textContent = `Temps restant : ${timeLeftForQuestion}s`;
            if (timeLeftForQuestion <= 0) {
                clearInterval(questionTimer);
                // Simuler une mauvaise r√©ponse ou passer √† la question suivante
                handleAnswer(false); // R√©ponse incorrecte due au temps √©coul√©
                nextBtn.click(); // Passe √† la question suivante
            }
        }, 1000);
    }

    function stopTimer() {
        clearInterval(questionTimer);
        timerDisplay.textContent = '';
    }

    function handleAnswer(isCorrect) {
        const currentQuestion = questionsForThisQuiz[currentQuestionIndex];
        const promptHash = stringToHash(currentQuestion.prompt);
        let questionResults = {}; // Pour stocker le r√©sultat de cette question pour saveQuizStats
        
        if (isCorrect) {
            score += DIFFICULTY_POINTS[currentQuestion.difficulty || 'easy']; // Ajoute des points pond√©r√©s
            feedbackEl.className = 'feedback correct';
            feedbackEl.textContent = "‚úÖ Bonne r√©ponse !";
            questionResults[promptHash] = 'correct';
        } else {
            feedbackEl.className = 'feedback incorrect';
            feedbackEl.innerHTML = `‚ùå Mauvaise r√©ponse.<br>La bonne r√©ponse √©tait : <strong>${currentQuestion.answer}</strong>.`;
            if (currentQuestion.explication) {
                explanationBtn.style.display = "block";
                explanationBtn.textContent = "Voir l'explication";
            }
            questionResults[promptHash] = 'incorrect';

            if (selectedGameMode === 'survival') {
                endQuiz(true); // Termine le quiz imm√©diatement en mode survie
                return;
            }
        }
        
        saveQuizStats(currentQuizData.quizId, score, currentQuestionIndex + 1, questionResults); // Sauvegarde les stats √† chaque question
        nextBtn.style.display = "block";
        scoreEl.textContent = `Score : ${score} / ${currentQuestionIndex + 1} (Q. ${currentQuestionIndex + 1}/${questionsForThisQuiz.length})`;
        form.style.display = "none";
    }

    form.addEventListener("submit", function(e) {
        e.preventDefault();
        submitBtn.disabled = true;
        stopTimer(); // Arr√™te le timer quand l'utilisateur r√©pond
        const userAnswer = answerSelect.value;
        const currentQuestion = questionsForThisQuiz[currentQuestionIndex];
        const correctAnswer = currentQuestion.answer;

        handleAnswer(userAnswer === correctAnswer);
    });
    
    explanationBtn.addEventListener("click", () => {
        const currentQuestion = questionsForThisQuiz[currentQuestionIndex];
        const explicationText = `<br><br><strong>Explication :</strong><br>${currentQuestion.explication}`;
        
        if (explanationBtn.textContent === "Voir l'explication") {
            feedbackEl.innerHTML += explicationText;
            explanationBtn.textContent = "Cacher l'explication";
        } else {
            feedbackEl.innerHTML = `‚ùå Mauvaise r√©ponse.<br>La bonne r√©ponse √©tait : <strong>${currentQuestion.answer}</strong>.`;
            explanationBtn.textContent = "Voir l'explication";
        }
    });

    nextBtn.addEventListener("click", () => {
        currentQuestionIndex++;
        updateQuestion();
    });
    
    function endQuiz(survivalFailed = false) {
        stopTimer(); // S'assurer que le timer est arr√™t√©

        const quizLength = questionsForThisQuiz.length;
        phraseEl.textContent = "üéâ Quiz termin√© !";
        progressBarFill.style.width = '100%';

        let finalMessage = `Ton score final est de ${score} sur ${quizLength}.`;
        if (survivalFailed) {
            finalMessage = `Game Over ! Tu as √©chou√© en mode Survie. Ton score √©tait de ${score}.`;
        }

        const stats = getQuizStatsForCurrentUser(currentQuizData.quizId);
        // Note: saveQuizStats est appel√©e √† chaque question soumise, donc le high score est d√©j√† √† jour.
        const isNewHighScore = (score > stats.highScore); // V√©ricle si c'est un nouveau record
        
        if (isNewHighScore) {
            finalMessage += "\n\n‚ú® Nouveau record personnel ! F√©licitations ! ‚ú®";
            stats.highScore = score; // S'assurer que le high score est mis √† jour
        }
        saveUsers(); // Sauvegarde finale des stats

        feedbackEl.textContent = finalMessage;
        
        form.style.display = "none";
        explanationBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        endQuizBtns.style.display = 'block';
        scoreEl.textContent = `Score final : ${score} / ${quizLength}`;
        viewQuizStatsBtn.style.display = 'block'; // Afficher le bouton pour voir les stats du quiz termin√©
    }

    replayBtn.addEventListener('click', startQuiz); // Rejoue avec les m√™mes options
    viewQuizStatsBtn.addEventListener('click', () => {
        displayOverallStats(); // Affiche les statistiques apr√®s un quiz termin√©
        statsForQuizTitle.textContent = currentQuizData.title;
        statsHighScore.textContent = getQuizStatsForCurrentUser(currentQuizData.quizId).highScore;
        // Ici, vous pouvez affiner l'affichage des questions rat√©es pour le quiz sp√©cifique
        const stats = getQuizStatsForCurrentUser(currentQuizData.quizId);
        const mostFailedQuestions = {};
        for (const promptHash in stats.questionPerformance) {
            const qPerf = stats.questionPerformance[promptHash];
            const questionData = findQuestionByHash(currentQuizData.quizId, promptHash);
            if (questionData) {
                const prompt = questionData.prompt;
                if (!mostFailedQuestions[prompt]) {
                    mostFailedQuestions[prompt] = { correct: 0, incorrect: 0 };
                }
                mostFailedQuestions[prompt].correct += qPerf.correct;
                mostFailedQuestions[prompt].incorrect += qPerf.incorrect;
            }
        }
        const sortedFailedQuestions = Object.entries(mostFailedQuestions)
            .filter(([, data]) => data.incorrect > 0) // Toutes celles qui ont √©t√© rat√©es au moins une fois
            .sort((a, b) => (b[1].incorrect - b[1].correct) - (a[1].incorrect - a[1].correct)) // Trier par diff√©rence
            .slice(0, 5); // Top 5
        
        failedQuestionsList.innerHTML = '';
        if (sortedFailedQuestions.length > 0) {
            sortedFailedQuestions.forEach(([prompt, data]) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>"${prompt}"</strong> <br> (Correct: <span class="stat-correct">${data.correct}</span>, Incorrect: <span class="stat-incorrect">${data.incorrect}</span>)`;
                failedQuestionsList.appendChild(li);
            });
        } else {
            failedQuestionsList.innerHTML = '<li>Aucune question n\'a √©t√© rat√©e. Excellent travail !</li>';
        }
    });

    backToMainMenuFromStatsBtn.addEventListener('click', showMenu);

    // --- LOGIQUE DU TH√àME SOMBRE ---
    function applyTheme(theme) {
        document.body.classList.toggle('dark-mode', theme === 'dark');
        themeToggleBtn.textContent = theme === 'dark' ? 'Th√®me Clair' : 'Th√®me Sombre';
        localStorage.setItem('quizTheme', theme);
    }
    themeToggleBtn.addEventListener('click', () => {
        const currentTheme = localStorage.getItem('quizTheme') || 'light';
        applyTheme(currentTheme === 'light' ? 'dark' : 'light');
    });

    // --- GESTION DES S√âLECTIONS D'OPTIONS DE JEU ---
    gameModeOptions.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            Array.from(gameModeOptions.children).forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');
            selectedGameMode = e.target.dataset.mode;
        }
    });

    difficultyOptions.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            Array.from(difficultyOptions.children).forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');
            selectedDifficulty = e.target.dataset.difficulty;
        }
    });

    startFiguresBtn.addEventListener('click', () => selectQuiz('figures'));
    startTonalitesBtn.addEventListener('click', () => selectQuiz('tonalites'));
    startSelectedQuizBtn.addEventListener('click', startQuiz);


    // --- Initialisation de la page ---
    async function initialize() {
        const savedTheme = localStorage.getItem('quizTheme') || 'light';
        applyTheme(savedTheme);
        // await fetchAllQuizData(); // Removed fetch call as data is now directly embedded.
        loadUsers(); // Charger les profils utilisateur
        showMenu();
    }
    
    // √âv√©nements des boutons de profil
    createUserBtn.addEventListener('click', createUser);
    loadUserBtn.addEventListener('click', () => {
        const username = usernameInput.value.trim();
        if (username) {
            loadUser(username);
        } else {
            alert("Veuillez entrer un nom d'utilisateur √† charger.");
        }
    });
    viewStatsBtn.addEventListener('click', displayOverallStats);


    initialize();
</script>
</body>
</html>
