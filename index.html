<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Litt√©raires Avanc√©</title>
<style>
    /* Th√®me Clair (par d√©faut) */
    :root {
        --bg-color: #f0f0f0;
        --text-color: #333;
        --header-color: #222;
        --phrase-color: #555;
        --select-bg: #fff;
        --select-border: #c0c0c0;
        --button-primary-bg: #0078d4;
        --button-primary-hover: #005a9e;
        --button-secondary-bg: #6c757d;
        --button-secondary-hover: #5a6268;
        --feedback-correct: #28a745;
        --feedback-incorrect: #dc3545;
        --container-bg: #ffffff;
        --progress-bg: #e0e0e0;
        --progress-fill: #4CAF50;
        --input-bg: #fff;
        --input-border: #ccc;
    }

    /* Th√®me Sombre */
    .dark-mode {
        --bg-color: #121212;
        --text-color: #f0f0f0;
        --header-color: #ffffff;
        --phrase-color: #cccccc;
        --select-bg: #333333;
        --select-border: #666666;
        --container-bg: #1e1e1e;
        --progress-bg: #333;
        --progress-fill: #66BB6A;
        --input-bg: #222;
        --input-border: #555;
    }

    body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
        transition: background 0.3s, color 0.3s;
    }

    .header-container {
        width: 100%;
        max-width: 580px;
        display: flex;
        justify-content: space-between; /* Pour espacer les √©l√©ments */
        align-items: center;
        padding: 0 10px;
        margin-bottom: 20px;
    }
    
    #themeToggleBtn {
        background: var(--button-secondary-bg);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
    }

    #currentUserDisplay {
        font-size: 0.9em;
        color: var(--phrase-color);
    }

    .main-content {
        max-width: 580px;
        width: 100%;
        text-align: center;
    }

    #quizTitle {
        font-size: 2.5em;
        margin-bottom: 5px;
        color: var(--header-color);
    }

    #highScoreDisplay {
        font-size: 1.1em;
        color: var(--phrase-color);
        margin-bottom: 15px;
        min-height: 20px;
    }
    #timerDisplay {
        font-size: 1.2em;
        font-weight: bold;
        color: var(--feedback-incorrect);
        margin-bottom: 10px;
        min-height: 20px;
    }

    /* --- Styles du Menu de S√©lection --- */
    #selectionContainer h1 {
        font-size: 2.8em;
        color: var(--header-color);
        margin-bottom: 30px;
    }

    .menu-section {
        background: var(--container-bg);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        text-align: left;
    }
    .menu-section h2 {
        color: var(--header-color);
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.6em;
        border-bottom: 1px solid var(--select-border);
        padding-bottom: 10px;
    }
    .menu-section label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: var(--text-color);
    }
    .menu-section input[type="text"],
    .menu-section select {
        width: calc(100% - 20px);
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid var(--input-border);
        border-radius: 4px;
        background-color: var(--input-bg);
        color: var(--text-color);
        font-size: 1em;
    }
    .menu-section button {
        margin-top: 10px;
        width: auto;
        padding: 10px 20px;
    }
    .menu-section .profile-list button {
        display: inline-block;
        margin-right: 10px;
        margin-bottom: 10px;
        max-width: fit-content;
        background: var(--button-secondary-bg);
    }
    .menu-section .profile-list button:hover {
        background: var(--button-secondary-hover);
    }

    .quiz-choice-btn {
        font-size: 1.3em;
        padding: 15px 25px;
        width: 100%;
        max-width: 400px;
        margin-top: 15px;
        margin-bottom: 15px;
    }
    .quiz-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }
    .quiz-options button {
        flex: 1;
        min-width: 120px;
        padding: 10px 15px;
        font-size: 0.9em;
        background-color: var(--button-secondary-bg);
    }
    .quiz-options button.selected {
        background-color: var(--button-primary-bg);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }


    /* --- Styles du Quiz --- */
    .progress-bar-container {
        width: 100%;
        background-color: var(--progress-bg);
        border-radius: 5px;
        margin-bottom: 25px;
        height: 10px;
        overflow: hidden; /* Ensure fill doesn't overflow */
    }

    .progress-bar-fill {
        height: 100%;
        width: 0%;
        background-color: var(--progress-fill);
        border-radius: 5px;
        transition: width 0.3s ease-in-out;
    }

    .phrase {
        font-style: italic;
        font-size: 1.5em;
        margin: 30px 0 25px 0;
        line-height: 1.5;
        color: var(--phrase-color);
        padding: 15px;
        background: var(--bg-color);
        border-radius: 8px;
    }

    select {
        width: 100%;
        padding: 12px 15px;
        font-size: 1.1em;
        margin-bottom: 25px;
        border: 1px solid var(--select-border);
        border-radius: 4px;
        background-color: var(--select-bg);
        color: var(--text-color);
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%204%205%22%3E%3Cpath%20fill%3D%22%23cccccc%22%20d%3D%22M2%200L0%202h4L2%200zM2%205L0%203h4L2%205z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 8px 10px;
        cursor: pointer;
    }

    button {
        padding: 12px 28px;
        font-size: 1.15em;
        background: var(--button-primary-bg);
        border: none;
        color: white;
        cursor: pointer;
        width: 100%;
        max-width: 350px;
        border-radius: 4px;
        transition: background 0.2s ease;
        margin: 10px auto;
        display: block;
    }
    button:hover { background: var(--button-primary-hover); }

    #explanationBtn, #backToMenuBtn { background: var(--button-secondary-bg); }
    #explanationBtn:hover, #backToMenuBtn:hover { background: var(--button-secondary-hover); }
    
    .feedback {
        margin-top: 30px;
        font-weight: bold;
        min-height: 80px;
        font-size: 1.25em;
        line-height: 1.5;
        white-space: pre-wrap; /* Pour afficher les retours √† la ligne */
    }
    .feedback.correct { color: var(--feedback-correct); }
    .feedback.incorrect { color: var(--feedback-incorrect); }

    .score { margin-top: 35px; font-size: 1.3em; color: var(--phrase-color); }
    #quizContainer { display: none; width: 100%; }
    #statsContainer { display: none; width: 100%; }
    #statsContainer h2 {
        color: var(--header-color);
        font-size: 2em;
        margin-bottom: 20px;
    }
    #statsDetails p {
        font-size: 1.1em;
        margin-bottom: 10px;
    }
    #statsDetails ul {
        list-style: none;
        padding: 0;
        margin-top: 20px;
    }
    #statsDetails ul li {
        background: var(--container-bg);
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .stat-correct { color: var(--feedback-correct); font-weight: bold; }
    .stat-incorrect { color: var(--feedback-incorrect); font-weight: bold; }

</style>
</head>
<body>

<div class="header-container">
    <span id="currentUserDisplay"></span>
    <button id="themeToggleBtn">Th√®me Sombre</button>
</div>

<div class="main-content">
    <div id="selectionContainer">
        <h1>Quiz Litt√©raires</h1>

        <div class="menu-section">
            <h2>G√©rer les Profils</h2>
            <label for="usernameInput">Nom d'utilisateur :</label>
            <input type="text" id="usernameInput" placeholder="Entrez votre nom" />
            <button id="createUserBtn">Cr√©er Nouveau Profil</button>
            <button id="loadUserBtn">Charger Profil</button>
            <div id="profileList" class="profile-list" style="margin-top: 15px;">
                <!-- Les profils charg√©s seront ins√©r√©s ici -->
            </div>
            <p style="font-size: 0.9em; margin-top: 15px;">Profil actif : <strong id="activeUserProfile">Aucun</strong></p>
            <button id="viewStatsBtn" style="display: none;">Voir mes Statistiques</button>
        </div>

        <div class="menu-section">
            <h2>Choisir un Quiz</h2>
            <button id="startFiguresBtn" class="quiz-choice-btn">üß† Figures de Style</button>
            <button id="startTonalitesBtn" class="quiz-choice-btn">üìò Tonalit√©s Litt√©raires</button>
        </div>

        <div class="menu-section" id="gameOptionsSection" style="display: none;">
            <h2>Options de Jeu</h2>
            <label>Mode de Jeu :</label>
            <div class="quiz-options" id="gameModeOptions">
                <button data-mode="normal" class="selected">Normal</button>
                <button data-mode="survival">Survie</button>
                <button data-mode="timetrial">Contre-la-montre</button>
                <button data-mode="revision">R√©vision</button>
            </div>

            <label for="difficultySelect" style="margin-top: 15px;">Difficult√© :</label>
            <div class="quiz-options" id="difficultyOptions">
                <button data-difficulty="any" class="selected">Al√©atoire</button>
                <button data-difficulty="easy">Facile</button>
                <button data-difficulty="medium">Moyen</button>
                <button data-difficulty="hard">Difficile</button>
            </div>
            
            <button id="startSelectedQuizBtn" style="margin-top: 20px;">D√©marrer le Quiz</button>
        </div>
    </div>

    <div id="quizContainer">
        <h1 id="quizTitle"></h1>
        <div id="highScoreDisplay"></div>
        <div id="timerDisplay"></div> <!-- Nouveau : Affichage du timer -->
        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>
        <div class="phrase" id="phrase"></div>
        <form id="form">
            <label for="answer" style="display: none;">R√©ponse :</label><br>
            <select id="answer" required></select><br>
            <button type="submit" id="submitBtn">Valider</button>
        </form>
        <div id="feedback" class="feedback"></div>
        <div id="score" class="score"></div>
        <button id="explanationBtn" style="display: none;">Voir l'explication</button>
        <button id="nextBtn" style="display: none;">Suivant</button>
        <div id="endQuizBtns" style="display: none;">
            <button id="replayBtn">Rejouer</button>
            <button id="backToMenuBtn">Retour au Menu</button>
            <button id="viewQuizStatsBtn">Statistiques du Quiz</button> <!-- Nouveau bouton pour stats du quiz termin√© -->
        </div>
    </div>

    <div id="statsContainer">
        <h2>Statistiques de <span id="statsUserName"></span></h2>
        <div id="statsDetails">
            <!-- Les statistiques d√©taill√©es seront ins√©r√©es ici -->
            <p>Score total le plus √©lev√© pour <span id="statsForQuizTitle"></span>: <span id="statsHighScore"></span></p>
            <h3>Performance par Question (top 5 des plus rat√©es) :</h3>
            <ul id="failedQuestionsList"></ul>
        </div>
        <button id="backToMainMenuFromStatsBtn">Retour au Menu Principal</button>
    </div>
</div>

<script>
    // --- GESTION DES √âL√âMENTS DU DOM ---
    const selectionContainer = document.getElementById('selectionContainer');
    const quizContainer = document.getElementById('quizContainer');
    const statsContainer = document.getElementById('statsContainer');

    const usernameInput = document.getElementById('usernameInput');
    const createUserBtn = document.getElementById('createUserBtn');
    const loadUserBtn = document.getElementById('loadUserBtn');
    const profileList = document.getElementById('profileList');
    const activeUserProfileDisplay = document.getElementById('activeUserProfile');
    const currentUserDisplay = document.getElementById('currentUserDisplay'); // En-t√™te global
    const viewStatsBtn = document.getElementById('viewStatsBtn');

    const startFiguresBtn = document.getElementById('startFiguresBtn');
    const startTonalitesBtn = document.getElementById('startTonalitesBtn');
    const gameOptionsSection = document.getElementById('gameOptionsSection');
    const gameModeOptions = document.getElementById('gameModeOptions');
    const difficultyOptions = document.getElementById('difficultyOptions');
    const startSelectedQuizBtn = document.getElementById('startSelectedQuizBtn');
    
    const quizTitleEl = document.getElementById('quizTitle');
    const highScoreDisplay = document.getElementById('highScoreDisplay');
    const timerDisplay = document.getElementById('timerDisplay'); // Nouveau : Affichage du timer
    const progressBarFill = document.getElementById('progressBarFill');
    const phraseEl = document.getElementById('phrase');
    const form = document.getElementById('form');
    const answerSelect = document.getElementById('answer');
    const feedbackEl = document.getElementById('feedback');
    const scoreEl = document.getElementById('score');
    
    const submitBtn = document.getElementById('submitBtn');
    const explanationBtn = document.getElementById('explanationBtn');
    const nextBtn = document.getElementById('nextBtn');
    const endQuizBtns = document.getElementById('endQuizBtns');
    const replayBtn = document.getElementById('replayBtn');
    const backToMenuBtn = document.getElementById('backToMenuBtn');
    const viewQuizStatsBtn = document.getElementById('viewQuizStatsBtn'); // Bouton pour voir stats du quiz termin√©
    const backToMainMenuFromStatsBtn = document.getElementById('backToMainMenuFromStatsBtn');
    const themeToggleBtn = document.getElementById('themeToggleBtn');

    const statsUserName = document.getElementById('statsUserName');
    const statsForQuizTitle = document.getElementById('statsForQuizTitle');
    const statsHighScore = document.getElementById('statsHighScore');
    const failedQuestionsList = document.getElementById('failedQuestionsList');

    // --- VARIABLES GLOBALES DU QUIZ ET DU PROFIL ---
    // Les donn√©es des quiz sont maintenant directement int√©gr√©es pour √©viter les erreurs de chargement.
    let allQuizData = {
        'figures': {
            "title": "üß† Figures de Style",
            "quizId": "figures",
            "defaultLength": 10,
            "questions": [
                { "prompt": "La mer est un miroir.", "answer": "m√©taphore", "explication": "La mer est compar√©e directement √† un miroir sans outil de comparaison.", "difficulty": "easy" },
                { "prompt": "Ses yeux √©taient deux √©toiles brillantes.", "answer": "m√©taphore", "explication": "Les yeux sont directement compar√©s √† des √©toiles sans outil de comparaison.", "difficulty": "easy" },
                { "prompt": "Cette femme est une v√©ritable vip√®re.", "answer": "m√©taphore", "explication": "La femme est directement associ√©e √† une vip√®re pour signifier sa m√©chancet√©.", "difficulty": "medium" },
                { "prompt": "Le temps, c'est de l'argent.", "answer": "m√©taphore", "explication": "Association directe entre le temps et l'argent pour en souligner la valeur.", "difficulty": "easy" },
                { "prompt": "Il est rus√© comme un renard.", "answer": "comparaison", "explication": "On utilise 'comme' pour comparer deux choses.", "difficulty": "easy" },
                { "prompt": "Ton rire est doux comme une m√©lodie.", "answer": "comparaison", "explication": "Utilisation de 'comme' pour comparer le rire √† une m√©lodie.", "difficulty": "easy" },
                { "prompt": "Ses cheveux sont blonds comme les bl√©s.", "answer": "comparaison", "explication": "L'outil 'comme' est utilis√© pour comparer la couleur des cheveux √† celle du bl√©.", "difficulty": "medium" },
                { "prompt": "Il est fort tel un ch√™ne.", "answer": "comparaison", "explication": "L'outil 'tel' est utilis√© pour comparer la force de la personne √† celle d'un ch√™ne.", "difficulty": "medium" },
                { "prompt": "Le vent hurlait dans la nuit.", "answer": "personnification", "explication": "Le vent est d√©crit comme s'il avait une action humaine : hurler.", "difficulty": "easy" },
                { "prompt": "Les arbres murmuraient des secrets.", "answer": "personnification", "explication": "Les arbres sont dot√©s de la capacit√© humaine de murmurer des secrets.", "difficulty": "easy" },
                { "prompt": "La fortune lui souriait.", "answer": "personnification", "explication": "On attribue une action humaine ('sourire') √† un concept abstrait ('la fortune').", "difficulty": "medium" },
                { "prompt": "Le soleil caressait les champs.", "answer": "personnification", "explication": "Le soleil est dot√© d'une action humaine : caresser.", "difficulty": "medium" },
                { "prompt": "Je suis mort de fatigue.", "answer": "hyperbole", "explication": "Exag√©ration forte pour insister sur la fatigue.", "difficulty": "easy" },
                { "prompt": "J'ai une faim de loup.", "answer": "hyperbole", "explication": "Exag√©ration pour exprimer une tr√®s grande faim.", "difficulty": "easy" },
                { "prompt": "Il a vers√© des torrents de larmes.", "answer": "hyperbole", "explication": "Exag√©ration de la quantit√© de larmes pour montrer une grande tristesse.", "difficulty": "medium" },
                { "prompt": "J'ai des tonnes de travail.", "answer": "hyperbole", "explication": "Exag√©ration pour insister sur la quantit√© de travail.", "difficulty": "medium" },
                { "prompt": "Cette obscure clart√©.", "answer": "oxymore", "explication": "Association de mots contraires : 'obscure' et 'clart√©'.", "difficulty": "medium" },
                { "prompt": "Un silence √©loquent.", "answer": "oxymore", "explication": "Association des termes 'silence' et '√©loquent' qui sont contraires.", "difficulty": "medium" },
                { "prompt": "Une douce violence.", "answer": "oxymore", "explication": "Association de 'douce' et 'violence', termes oppos√©s.", "difficulty": "hard" },
                { "prompt": "Un mort-vivant.", "answer": "oxymore", "explication": "Les termes 'mort' et 'vivant' sont directement oppos√©s et accol√©s.", "difficulty": "hard" },
                { "prompt": "Le roi des animaux.", "answer": "p√©riphrase", "explication": "Expression qui remplace 'Le lion'.", "difficulty": "easy" },
                { "prompt": "La ville Lumi√®re.", "answer": "p√©riphrase", "explication": "Expression qui remplace 'Paris'.", "difficulty": "easy" },
                { "prompt": "Le septi√®me art.", "answer": "p√©riphrase", "explication": "Expression qui remplace 'le cin√©ma'.", "difficulty": "medium" },
                { "prompt": "L'√Æle de Beaut√©.", "answer": "p√©riphrase", "explication": "Expression qui d√©signe 'la Corse'.", "difficulty": "medium" },
                { "prompt": "Va, je ne te hais point.", "answer": "litote", "explication": "On dit moins ('ne pas ha√Ør') pour sugg√©rer plus ('aimer').", "difficulty": "hard" },
                { "prompt": "Ce n'est pas mal du tout.", "answer": "litote", "explication": "Dire 'pas mal' pour signifier 'tr√®s bien'.", "difficulty": "medium" },
                { "prompt": "Il n'est pas sot.", "answer": "litote", "explication": "N√©gation de 'sot' pour affirmer qu'il est intelligent.", "difficulty": "medium" },
                { "prompt": "Ce plat n'est pas mauvais.", "answer": "litote", "explication": "Att√©nuation pour dire que le plat est bon.", "difficulty": "easy" },
                { "prompt": "Il a rejoint les √©toiles.", "answer": "euph√©misme", "explication": "Adoucissement pour dire qu'il est mort.", "difficulty": "easy" },
                { "prompt": "Il nous a quitt√©s.", "answer": "euph√©misme", "explication": "Adoucissement pour dire qu'il est d√©c√©d√©.", "difficulty": "easy" },
                { "prompt": "Les personnes du troisi√®me √¢ge.", "answer": "euph√©misme", "explication": "Expression adoucie pour parler des personnes √¢g√©es.", "difficulty": "medium" },
                { "prompt": "Un technicien de surface.", "answer": "euph√©misme", "explication": "Expression valorisante pour d√©signer un balayeur.", "difficulty": "medium" },
                { "prompt": "Je suis le roi, le ma√Ætre, le dieu.", "answer": "gradation", "explication": "Liste de mots de force croissante.", "difficulty": "medium" },
                { "prompt": "Elle marcha, courut, s'envola.", "answer": "gradation", "explication": "√ânum√©ration d'actions d'intensit√© croissante.", "difficulty": "medium" },
                { "prompt": "Il g√©mit, il crie, il hurle.", "answer": "gradation", "explication": "La progression de l'intensit√© du son est croissante.", "difficulty": "hard" },
                { "prompt": "C'est un roc, c'est un pic, c'est un cap !", "answer": "gradation", "explication": "C√©l√®bre gradation de Cyrano de Bergerac, d'intensit√© croissante.", "difficulty": "hard" },
                { "prompt": "Jour apr√®s jour, il revenait. Jour apr√®s jour, l'espoir grandissait.", "answer": "anaphore", "explication": "R√©p√©tition de 'Jour apr√®s jour' en d√©but de phrase pour insister.", "difficulty": "medium" },
                { "prompt": "Rien ne l'arr√™tait. Rien ne le freinait. Rien ne le d√©viait.", "answer": "anaphore", "explication": "R√©p√©tition de 'Rien ne' en d√©but de phrase.", "difficulty": "medium" },
                { "prompt": "Paris ! Paris outrag√© ! Paris bris√© ! Paris martyris√© ! mais Paris lib√©r√© !", "answer": "anaphore", "explication": "R√©p√©tition du mot 'Paris' en d√©but de membre de phrase.", "difficulty": "hard" },
                { "prompt": "Il aime la vie mais d√©teste la mort.", "answer": "antith√®se", "explication": "Opposition forte entre 'aime la vie' et 'd√©teste la mort'.", "difficulty": "easy" },
                { "prompt": "Je t'aime, je te hais.", "answer": "antith√®se", "explication": "Opposition forte entre 'aimer' et 'ha√Ør'.", "difficulty": "easy" },
                { "prompt": "√ätre ou ne pas √™tre, telle est la question.", "answer": "antith√®se", "explication": "Opposition fondamentale entre les concepts '√™tre' et 'ne pas √™tre'.", "difficulty": "medium" },
                { "prompt": "Lire un Zola.", "answer": "m√©tonymie", "explication": "On utilise le nom de l'auteur pour d√©signer son ≈ìuvre.", "difficulty": "easy" },
                { "prompt": "Boire un bordeaux.", "answer": "m√©tonymie", "explication": "On utilise le nom de la r√©gion pour d√©signer le vin.", "difficulty": "easy" },
                { "prompt": "Respecter le drapeau.", "answer": "m√©tonymie", "explication": "Le symbole ('drapeau') est utilis√© pour d√©signer le pays ou la nation.", "difficulty": "medium" },
                { "prompt": "J'ai achet√© une nouvelle voile.", "answer": "synecdoque", "explication": "On utilise une partie ('voile') pour d√©signer le tout ('bateau').", "difficulty": "medium" },
                { "prompt": "Il y a quarante t√™tes dans la classe.", "answer": "synecdoque", "explication": "Une partie ('t√™tes') d√©signe le tout (les √©l√®ves).", "difficulty": "medium" },
                { "prompt": "Les mortels ne peuvent √©chapper √† leur destin.", "answer": "synecdoque", "explication": "Le terme 'mortels' (une caract√©ristique) est utilis√© pour d√©signer 'les humains' (le tout).", "difficulty": "hard" },
                { "prompt": "Je te promets... le bonheur... la joie...", "answer": "ellipses", "explication": "Omission volontaire de mots pour cr√©er un effet de suspension ou d'√©motion.", "difficulty": "medium" },
                { "prompt": "Il est parti... sans un mot...", "answer": "ellipses", "explication": "Omission des mots pour laisser le lecteur imaginer la suite ou l'√©motion.", "difficulty": "medium" },
                { "prompt": "Heureux qui, comme Ulysse, a fait un beau voyage...", "answer": "ellipses", "explication": "Sous-entendu : 'Heureux est celui qui...' par allusion.", "difficulty": "hard" },
                { "prompt": "Monter en haut.", "answer": "pl√©onasme", "explication": "R√©p√©tition inutile de l'id√©e de hauteur, car 'monter' implique d√©j√† 'en haut'.", "difficulty": "easy" },
                { "prompt": "Pr√©voir √† l'avance.", "answer": "pl√©onasme", "explication": "Le verbe 'pr√©voir' contient d√©j√† l'id√©e d''√† l'avance'.", "difficulty": "easy" },
                { "prompt": "Un bref r√©sum√©.", "answer": "pl√©onasme", "explication": "Un r√©sum√© est par d√©finition bref, la r√©p√©tition est stylistique.", "difficulty": "medium" },
                { "prompt": "Ah, c'est du joli !", "answer": "antiphrase", "explication": "Dire l'inverse de ce que l'on pense pour exprimer de l'ironie (ici, cela signifie 'c'est moche').", "difficulty": "easy" },
                { "prompt": "Quelle belle journ√©e de pluie !", "answer": "antiphrase", "explication": "Dire 'belle journ√©e' pour signifier 'mauvaise journ√©e', avec intention ironique.", "difficulty": "easy" },
                { "prompt": "Ne te g√™ne surtout pas !", "answer": "antiphrase", "explication": "Dit ironiquement √† quelqu'un qui d√©range, pour signifier 'Tu me g√™nes'.", "difficulty": "medium" }
            ]
        },
        'tonalites': {
            "title": "üìò Tonalit√©s Litt√©raires",
            "quizId": "tonalites",
            "defaultLength": null,
            "questions": [
                { "prompt": "Le texte cherche √† faire rire ou sourire.", "answer": "Tonalit√© comique", "explication": "Situation absurde ou exag√©r√©e, jeux de mots, r√©p√©titions, caricature, ironie ou personnages ridicules.", "difficulty": "easy" },
                { "prompt": "Le personnage est condamn√© d‚Äôavance, il n‚Äôy a pas d‚Äôissue.", "answer": "Tonalit√© tragique", "explication": "Le personnage est face au destin, √† la mort. On trouve un vocabulaire du malheur, du destin, de la fatalit√© et un ton grave et solennel.", "difficulty": "medium" },
                { "prompt": "Le texte veut toucher le lecteur, montrer la douleur ou la souffrance.", "answer": "Tonalit√© path√©tique", "explication": "On trouve un vocabulaire de la tristesse, de la douleur, des phrases courtes ou exclamatives et des apostrophes (on parle √† quelqu‚Äôun ou √† Dieu).", "difficulty": "medium" },
                { "prompt": "Le texte exprime les √©motions personnelles (amour, nostalgie, joie, etc.).", "answer": "Tonalit√© lyrique", "explication": "Emploi de la 1re personne, champs lexicaux des sentiments (amour, tristesse, bonheur‚Ä¶) et ponctuation expressive (! ? ‚Ä¶).", "difficulty": "easy" },
                { "prompt": "C‚Äôest du lyrisme triste, souvent sur la mort, l‚Äôabsence ou le temps qui passe.", "answer": "Tonalit√© √©l√©giaque", "explication": "C'est une forme de lyrisme mais plus m√©lancolique, souvent dans des po√®mes (ex : Lamartine, Hugo).", "difficulty": "hard" },
                { "prompt": "Le texte met en valeur un h√©ros dans un combat grandiose.", "answer": "Tonalit√© √©pique", "explication": "Utilisation d'exag√©rations (hyperboles), de nombreux adjectifs, d'un vocabulaire du combat et du courage, et description d'actions spectaculaires.", "difficulty": "medium" },
                { "prompt": "Le texte attaque une id√©e ou une personne, parfois violemment.", "answer": "Tonalit√© pol√©mique", "explication": "On rep√®re un vocabulaire p√©joratif, des questions oratoires, des interpellations, de l'ironie et des critiques fortes.", "difficulty": "hard" },
                { "prompt": "Le texte se moque pour d√©noncer.", "answer": "Tonalit√© satirique", "explication": "On trouve un humour grin√ßant, un d√©tournement d‚Äôid√©es ou de situations, de l'ironie et des caricatures.", "difficulty": "hard" },
                { "prompt": "Le texte veut transmettre un savoir ou une le√ßon.", "answer": "Tonalit√© didactique", "explication": "Les phrases sont claires et structur√©es, avec des exemples ou des d√©finitions, dans un style logique et parfois imp√©ratif.", "difficulty": "easy" },
                { "prompt": "Quelque chose d‚Äô√©trange ou de surnaturel arrive dans un monde r√©aliste, cr√©ant une h√©sitation.", "answer": "Tonalit√© fantastique", "explication": "Il y a une h√©sitation entre r√™ve et r√©alit√©, un vocabulaire du doute (peut-√™tre, on dirait que‚Ä¶) et une ambiance inqui√©tante.", "difficulty": "medium" },
                { "prompt": "Le texte pr√©sente un monde magique, o√π le surnaturel est accept√© naturellement.", "answer": "Tonalit√© merveilleuse", "explication": "On trouve des √©l√©ments magiques (f√©es, dragons‚Ä¶) dans un vocabulaire f√©√©rique et imaginaire, sans aucun doute chez les personnages.", "difficulty": "easy" },
                { "prompt": "Tonalit√© qui met en sc√®ne des situations extr√™mes et des personnages aux passions violentes.", "answer": "Dramatique", "difficulty": "hard", "explication": "La tonalit√© dramatique est caract√©ristique des ≈ìuvres o√π les √©v√©nements s'encha√Ænent de mani√®re tendue, aboutissant souvent √† une crise ou un d√©nouement intense." }
            ]
        }
    }; 

    let currentQuizData = null; // Donn√©es du quiz actuellement s√©lectionn√©
    let questionsForThisQuiz = []; // Questions pour la session de quiz actuelle
    let currentQuestionIndex = 0;
    let score = 0;

    let activeUser = null; // L'objet du profil utilisateur actif
    let users = {}; // Tous les profils d'utilisateurs charg√©s depuis localStorage

    let selectedGameMode = 'normal';
    let selectedDifficulty = 'any';
    let quizTimer = null; // Pour le mode contre-la-montre
    const TIME_PER_QUESTION_SECONDS = 15; // Temps par question en mode contre-la-montre

    // --- POND√âRATION DES SCORES PAR DIFFICULT√â ---
    const DIFFICULTY_POINTS = {
        'easy': 1,
        'medium': 2,
        'hard': 3
    };

    // --- FONCTIONS DE GESTION DES PROFILS UTILISATEUR ---

    function loadUsers() {
        const storedUsers = localStorage.getItem('quizUsers');
        if (storedUsers) {
            users = JSON.parse(storedUsers);
            const activeUserId = localStorage.getItem('activeQuizUser');
            if (activeUserId && users[activeUserId]) {
                activeUser = users[activeUserId];
                updateActiveUserDisplay();
                viewStatsBtn.style.display = 'block';
            }
        }
        renderProfileList();
    }

    function saveUsers() {
        localStorage.setItem('quizUsers', JSON.stringify(users));
        if (activeUser) {
            localStorage.setItem('activeQuizUser', activeUser.id);
        } else {
            localStorage.removeItem('activeQuizUser');
        }
    }

    function createUser() {
        const username = usernameInput.value.trim();
        if (username.length < 3) {
            alert("Le nom d'utilisateur doit contenir au moins 3 caract√®res."); // Utiliser une modale custom dans une vraie app
            return;
        }
        if (users[username]) {
            alert("Ce nom d'utilisateur existe d√©j√†. Veuillez en choisir un autre ou le charger.");
            return;
        }

        const newUser = {
            id: username, // Pour la simplicit√©, l'ID est le nom d'utilisateur
            name: username,
            quizStats: {} // Stockera les performances de chaque quiz
        };
        users[username] = newUser;
        activeUser = newUser;
        saveUsers();
        updateActiveUserDisplay();
        alert(`Profil '${username}' cr√©√© et s√©lectionn√© !`);
        viewStatsBtn.style.display = 'block';
    }

    function loadUser(username) {
        if (!users[username]) {
            alert("Profil non trouv√©.");
            return;
        }
        activeUser = users[username];
        saveUsers();
        updateActiveUserDisplay();
        alert(`Profil '${username}' charg√© !`);
        viewStatsBtn.style.display = 'block';
    }

    function updateActiveUserDisplay() {
        if (activeUser) {
            activeUserProfileDisplay.textContent = activeUser.name;
            currentUserDisplay.textContent = `Bienvenue, ${activeUser.name} !`;
        } else {
            activeUserProfileDisplay.textContent = 'Aucun';
            currentUserDisplay.textContent = '';
        }
    }

    function renderProfileList() {
        profileList.innerHTML = '';
        for (const userId in users) {
            const userBtn = document.createElement('button');
            userBtn.textContent = users[userId].name;
            userBtn.addEventListener('click', () => loadUser(userId));
            profileList.appendChild(userBtn);
        }
    }

    // --- FONCTIONS DE GESTION DES QUIZ (Chargement & S√©lection) ---

    function selectQuiz(quizId) {
        if (!activeUser) {
            alert("Veuillez cr√©er ou charger un profil utilisateur avant de choisir un quiz.");
            return;
        }
        currentQuizData = allQuizData[quizId];
        if (currentQuizData) {
            // Afficher les options de jeu
            gameOptionsSection.style.display = 'block';
            // Mettre √† jour l'affichage du meilleur score pour le quiz s√©lectionn√©
            loadHighScore();
        }
    }

    // --- LOGIQUE DU HIGH SCORE ET STATS UTILISATEUR ---

    function getQuizStatsForCurrentUser(quizId, gameMode, difficulty) {
        if (!activeUser) return null;
        if (!activeUser.quizStats[quizId]) {
            activeUser.quizStats[quizId] = {};
        }
        if (!activeUser.quizStats[quizId][gameMode]) {
            activeUser.quizStats[quizId][gameMode] = {};
        }
        if (!activeUser.quizStats[quizId][gameMode][difficulty]) {
            activeUser.quizStats[quizId][gameMode][difficulty] = {
                highScore: 0,
                totalPlayed: 0,
                totalCorrect: 0,
                totalQuestionsAnswered: 0,
                questionPerformance: {} // { "prompt_hash": { correct: X, incorrect: Y } }
            };
        }
        return activeUser.quizStats[quizId][gameMode][difficulty];
    }

    function loadHighScore() {
        if (!currentQuizData || !activeUser) {
            highScoreDisplay.textContent = '';
            return;
        }
        const stats = getQuizStatsForCurrentUser(currentQuizData.quizId, selectedGameMode, selectedDifficulty);
        const quizLength = currentQuizData.defaultLength || currentQuizData.questions.length;
        highScoreDisplay.textContent = `üèÜ Record (${activeUser.name} - ${selectedGameMode}, ${selectedDifficulty}) : ${stats.highScore} / ${quizLength}`;
    }

    function saveQuizStats(quizId, finalScore, totalQuestionsPlayed, questionResults) {
        if (!activeUser) return;
        const stats = getQuizStatsForCurrentUser(quizId, selectedGameMode, selectedDifficulty);
        
        stats.totalPlayed++;
        stats.totalCorrect += finalScore;
        stats.totalQuestionsAnswered += totalQuestionsPlayed;

        // Mise √† jour du meilleur score
        if (finalScore > stats.highScore) {
            stats.highScore = finalScore;
        }

        // Mise √† jour des performances par question
        for (const promptHash in questionResults) {
            if (!stats.questionPerformance[promptHash]) {
                stats.questionPerformance[promptHash] = { correct: 0, incorrect: 0 };
            }
            if (questionResults[promptHash] === 'correct') {
                stats.questionPerformance[promptHash].correct++;
            } else {
                stats.questionPerformance[promptHash].incorrect++;
            }
        }
        saveUsers(); // Sauvegarde tout l'objet users
    }

    function displayOverallStats() {
        if (!activeUser) {
            alert("Veuillez charger un profil pour voir les statistiques.");
            return;
        }
        selectionContainer.style.display = 'none';
        quizContainer.style.display = 'none';
        statsContainer.style.display = 'block';

        statsUserName.textContent = activeUser.name;
        statsForQuizTitle.textContent = "tous les quiz"; // Afficher les stats g√©n√©rales

        let totalHighScoreSum = 0;
        let mostFailedQuestions = {}; // { prompt: { correct: X, incorrect: Y } }

        for (const quizId in activeUser.quizStats) {
            for (const mode in activeUser.quizStats[quizId]) {
                for (const difficulty in activeUser.quizStats[quizId][mode]) {
                    const stats = activeUser.quizStats[quizId][mode][difficulty];
                    totalHighScoreSum += stats.highScore; // Cumuler les meilleurs scores

                    for (const promptHash in stats.questionPerformance) {
                        const qPerf = stats.questionPerformance[promptHash];
                        const questionData = findQuestionByHash(quizId, promptHash); 
                        if (questionData) {
                            const prompt = questionData.prompt;
                            if (!mostFailedQuestions[prompt]) {
                                mostFailedQuestions[prompt] = { correct: 0, incorrect: 0 };
                            }
                            mostFailedQuestions[prompt].correct += qPerf.correct;
                            mostFailedQuestions[prompt].incorrect += qPerf.incorrect;
                        }
                    }
                }
            }
        }

        statsHighScore.textContent = `${totalHighScoreSum} points (sur les meilleurs scores cumul√©s)`;
        
        const sortedFailedQuestions = Object.entries(mostFailedQuestions)
            .filter(([, data]) => data.incorrect > data.correct) 
            .sort((a, b) => (b[1].incorrect - b[1].correct) - (a[1].incorrect - a[1].correct)) 
            .slice(0, 5); 

        failedQuestionsList.innerHTML = '';
        if (sortedFailedQuestions.length > 0) {
            sortedFailedQuestions.forEach(([prompt, data]) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>"${prompt}"</strong> <br> (Correct: <span class="stat-correct">${data.correct}</span>, Incorrect: <span class="stat-incorrect">${data.incorrect}</span>)`;
                failedQuestionsList.appendChild(li);
            });
        } else {
            failedQuestionsList.innerHTML = '<li>Aucune question n\'a √©t√© rat√©e plus d\'une fois. Continuez comme √ßa !</li>';
        }
    }

    // Utility to find question data by hash (for stats display)
    function findQuestionByHash(quizId, promptHash) {
        const quiz = allQuizData[quizId];
        if (quiz) {
            return quiz.questions.find(q => stringToHash(q.prompt) === promptHash);
        }
        return null;
    }


    // --- LOGIQUE DU QUIZ (G√©n√©rique) ---

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function populateSelectOptions() {
        answerSelect.innerHTML = '<option value="" disabled selected>Choisis une r√©ponse</option>';
        const answers = currentQuizData.questions.map(q => q.answer);
        const uniqueAnswers = [...new Set(answers)].sort();
        uniqueAnswers.forEach(answer => {
            const option = document.createElement('option');
            option.value = answer;
            option.textContent = answer.charAt(0).toUpperCase() + answer.slice(1);
            answerSelect.appendChild(option);
        });
    }

    function stringToHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0; // Convert to 32bit integer
        }
        return hash.toString();
    }

    function showMenu() {
        selectionContainer.style.display = 'block';
        quizContainer.style.display = 'none';
        statsContainer.style.display = 'none';
        gameOptionsSection.style.display = 'none'; // Hide game options when returning to main menu
        // Reset selected game mode and difficulty to defaults for next selection
        selectedGameMode = 'normal';
        selectedDifficulty = 'any';
        Array.from(gameModeOptions.children).forEach(btn => {
            btn.classList.remove('selected');
            if (btn.dataset.mode === 'normal') btn.classList.add('selected');
        });
        Array.from(difficultyOptions.children).forEach(btn => {
            btn.classList.remove('selected');
            if (btn.dataset.difficulty === 'any') btn.classList.add('selected');
        });
    }

    function startQuiz() {
        if (!currentQuizData) {
            alert("Veuillez s√©lectionner un quiz.");
            return;
        }
        if (!activeUser) {
            alert("Veuillez cr√©er ou charger un profil utilisateur.");
            return;
        }

        // Filtration des questions par difficult√©
        let availableQuestions = [...currentQuizData.questions];
        if (selectedDifficulty !== 'any') {
            availableQuestions = availableQuestions.filter(q => q.difficulty === selectedDifficulty);
        }

        // Logique du mode R√©vision (pour plus tard)
        if (selectedGameMode === 'revision') {
            const stats = getQuizStatsForCurrentUser(currentQuizData.quizId, selectedGameMode, selectedDifficulty);
            const failedQuestionHashes = Object.keys(stats.questionPerformance).filter(hash => 
                stats.questionPerformance[hash].incorrect > stats.questionPerformance[hash].correct
            );
            if (failedQuestionHashes.length > 0) {
                // Cr√©er un tableau de questions bas√©es sur les hachages des questions rat√©es
                questionsForThisQuiz = failedQuestionHashes.map(hash => 
                    availableQuestions.find(q => stringToHash(q.prompt) === hash)
                ).filter(q => q !== undefined); // Filtrer les undefined si une question n'est plus trouv√©e
                
                // If revision questions are filtered by difficulty, ensure they match
                if (selectedDifficulty !== 'any') {
                    questionsForThisQuiz = questionsForThisQuiz.filter(q => q.difficulty === selectedDifficulty);
                }
                
                if (questionsForThisQuiz.length === 0) {
                     alert("Pas de questions √† r√©viser avec la difficult√© s√©lectionn√©e, ou toutes les questions rat√©es ont √©t√© ma√Ætris√©es !");
                     showMenu();
                     return;
                }
            } else {
                alert("Vous n'avez pas encore de questions √† r√©viser pour ce quiz.");
                showMenu();
                return;
            }
        } else {
            // Pour les autres modes, m√©langer et prendre le nombre par d√©faut ou toutes
            shuffleArray(availableQuestions);
            const quizLength = currentQuizData.defaultLength ? 
                               Math.min(currentQuizData.defaultLength, availableQuestions.length) :
                               availableQuestions.length;
            questionsForThisQuiz = availableQuestions.slice(0, quizLength);
        }

        if (questionsForThisQuiz.length === 0) {
            alert("Aucune question ne correspond √† vos crit√®res de s√©lection (difficult√©, etc.) pour ce quiz.");
            showMenu();
            return;
        }

        selectionContainer.style.display = 'none';
        quizContainer.style.display = 'block';
        quizTitleEl.textContent = currentQuizData.title;
        loadHighScore(); // Appel sans arguments, car les valeurs sont globales
        timerDisplay.style.display = 'none'; // Cacher par d√©faut

        currentQuestionIndex = 0;
        score = 0;
        
        populateSelectOptions();
        updateQuestion();

        // D√©marrer le timer si en mode contre-la-montre
        if (selectedGameMode === 'timetrial') {
            startTimer();
            timerDisplay.style.display = 'block';
        } else {
            stopTimer(); // S'assurer que le timer est arr√™t√© si non en mode contre-la-montre
        }
    }
    
    function updateQuestion() {
        endQuizBtns.style.display = 'none';
        nextBtn.style.display = 'none';
        explanationBtn.style.display = 'none';

        if (currentQuestionIndex >= questionsForThisQuiz.length) {
            endQuiz();
            return;
        }

        const currentQuestion = questionsForThisQuiz[currentQuestionIndex];
        phraseEl.textContent = currentQuestion.prompt;
        answerSelect.value = "";
        feedbackEl.innerHTML = "";
        feedbackEl.className = 'feedback';
        scoreEl.textContent = `Score : ${score} / ${currentQuestionIndex} (Q. ${currentQuestionIndex + 1}/${questionsForThisQuiz.length})`;
        form.style.display = "block";
        submitBtn.style.display = "block";
        submitBtn.disabled = false;

        // Met √† jour la barre de progression
        const progress = (currentQuestionIndex / questionsForThisQuiz.length) * 100;
        progressBarFill.style.width = `${progress}%`;

        // R√©initialiser le timer pour la nouvelle question si en mode contre-la-montre
        if (selectedGameMode === 'timetrial') {
            resetTimerForQuestion();
        }
    }

    let questionTimer = null;
    let timeLeftForQuestion = TIME_PER_QUESTION_SECONDS;

    function startTimer() {
        resetTimerForQuestion(); // D√©marre le timer pour la premi√®re question
        // Le timer principal g√®re l'affichage du temps restant pour la question actuelle
        // Pas besoin de timer global pour le quiz entier pour l'instant.
    }

    function resetTimerForQuestion() {
        clearInterval(questionTimer);
        timeLeftForQuestion = TIME_PER_QUESTION_SECONDS;
        timerDisplay.textContent = `Temps restant : ${timeLeftForQuestion}s`;
        questionTimer = setInterval(() => {
            timeLeftForQuestion--;
            timerDisplay.textContent = `Temps restant : ${timeLeftForQuestion}s`;
            if (timeLeftForQuestion <= 0) {
                clearInterval(questionTimer);
                // Simuler une mauvaise r√©ponse ou passer √† la question suivante
                handleAnswer(false); // R√©ponse incorrecte due au temps √©coul√©
                nextBtn.click(); // Passe √† la question suivante
            }
        }, 1000);
    }

    function stopTimer() {
        clearInterval(questionTimer);
        timerDisplay.textContent = '';
    }

    function handleAnswer(isCorrect) {
        const currentQuestion = questionsForThisQuiz[currentQuestionIndex];
        const promptHash = stringToHash(currentQuestion.prompt);
        let questionResults = {}; // Pour stocker le r√©sultat de cette question pour saveQuizStats
        
        if (isCorrect) {
            score += DIFFICULTY_POINTS[currentQuestion.difficulty || 'easy']; // Ajoute des points pond√©r√©s
            feedbackEl.className = 'feedback correct';
            feedbackEl.textContent = "‚úÖ Bonne r√©ponse !";
            questionResults[promptHash] = 'correct';
        } else {
            feedbackEl.className = 'feedback incorrect';
            feedbackEl.innerHTML = `‚ùå Mauvaise r√©ponse.<br>La bonne r√©ponse √©tait : <strong>${currentQuestion.answer}</strong>.`;
            if (currentQuestion.explication) {
                explanationBtn.style.display = "block";
                explanationBtn.textContent = "Voir l'explication";
            }
            questionResults[promptHash] = 'incorrect';

            if (selectedGameMode === 'survival') {
                endQuiz(true); // Termine le quiz imm√©diatement en mode survie
                return;
            }
        }
        
        saveQuizStats(currentQuizData.quizId, score, currentQuestionIndex + 1, questionResults); // Sauvegarde les stats √† chaque question
        nextBtn.style.display = "block";
        scoreEl.textContent = `Score : ${score} / ${currentQuestionIndex + 1} (Q. ${currentQuestionIndex + 1}/${questionsForThisQuiz.length})`;
        form.style.display = "none";
    }

    form.addEventListener("submit", function(e) {
        e.preventDefault();
        submitBtn.disabled = true;
        stopTimer(); // Arr√™te le timer quand l'utilisateur r√©pond
        const userAnswer = answerSelect.value;
        const currentQuestion = questionsForThisQuiz[currentQuestionIndex];
        const correctAnswer = currentQuestion.answer;

        handleAnswer(userAnswer === correctAnswer);
    });
    
    explanationBtn.addEventListener("click", () => {
        const currentQuestion = questionsForThisQuiz[currentQuestionIndex];
        const explicationText = `<br><br><strong>Explication :</strong><br>${currentQuestion.explication}`;
        
        if (explanationBtn.textContent === "Voir l'explication") {
            feedbackEl.innerHTML += explicationText;
            explanationBtn.textContent = "Cacher l'explication";
        } else {
            feedbackEl.innerHTML = `‚ùå Mauvaise r√©ponse.<br>La bonne r√©ponse √©tait : <strong>${currentQuestion.answer}</strong>.`;
            explanationBtn.textContent = "Voir l'explication";
        }
    });

    nextBtn.addEventListener("click", () => {
        currentQuestionIndex++;
        updateQuestion();
    });
    
    function endQuiz(survivalFailed = false) {
        stopTimer(); // S'assurer que le timer est arr√™t√©

        const quizLength = questionsForThisQuiz.length;
        phraseEl.textContent = "üéâ Quiz termin√© !";
        progressBarFill.style.width = '100%';

        let finalMessage = `Ton score final est de ${score} sur ${quizLength}.`;
        if (survivalFailed) {
            finalMessage = `Game Over ! Tu as √©chou√© en mode Survie. Ton score √©tait de ${score}.`;
        }

        const stats = getQuizStatsForCurrentUser(currentQuizData.quizId, selectedGameMode, selectedDifficulty);
        // Note: saveQuizStats est appel√©e √† chaque question soumise, donc le high score est d√©j√† √† jour.
        const isNewHighScore = (score > stats.highScore); // V√©rifie si c'est un nouveau record
        
        if (isNewHighScore) {
            finalMessage += "\n\n‚ú® Nouveau record personnel ! F√©licitations ! ‚ú®";
            stats.highScore = score; // S'assurer que le high score est mis √† jour
        }
        saveUsers(); // Sauvegarde finale des stats

        feedbackEl.textContent = finalMessage;
        
        form.style.display = "none";
        explanationBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        endQuizBtns.style.display = 'block';
        scoreEl.textContent = `Score final : ${score} / ${quizLength}`;
        viewQuizStatsBtn.style.display = 'block'; // Afficher le bouton pour voir les stats du quiz termin√©
    }

    replayBtn.addEventListener('click', startQuiz); // Rejoue avec les m√™mes options
    viewQuizStatsBtn.addEventListener('click', () => {
        displayOverallStats(); // Affiche les statistiques apr√®s un quiz termin√©
        // Pour les statistiques sp√©cifiques √† ce quiz, mode et difficult√©:
        statsForQuizTitle.textContent = `${currentQuizData.title} (${selectedGameMode}, ${selectedDifficulty})`;
        statsHighScore.textContent = getQuizStatsForCurrentUser(currentQuizData.quizId, selectedGameMode, selectedDifficulty).highScore;
        
        const stats = getQuizStatsForCurrentUser(currentQuizData.quizId, selectedGameMode, selectedDifficulty);
        const mostFailedQuestions = {};
        for (const promptHash in stats.questionPerformance) {
            const qPerf = stats.questionPerformance[promptHash];
            const questionData = findQuestionByHash(currentQuizData.quizId, promptHash);
            if (questionData) {
                const prompt = questionData.prompt;
                if (!mostFailedQuestions[prompt]) {
                    mostFailedQuestions[prompt] = { correct: 0, incorrect: 0 };
                }
                mostFailedQuestions[prompt].correct += qPerf.correct;
                mostFailedQuestions[prompt].incorrect += qPerf.incorrect;
            }
        }
        const sortedFailedQuestions = Object.entries(mostFailedQuestions)
            .filter(([, data]) => data.incorrect > 0) 
            .sort((a, b) => (b[1].incorrect - b[1].correct) - (a[1].incorrect - a[1].correct)) 
            .slice(0, 5); 
        
        failedQuestionsList.innerHTML = '';
        if (sortedFailedQuestions.length > 0) {
            sortedFailedQuestions.forEach(([prompt, data]) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>"${prompt}"</strong> <br> (Correct: <span class="stat-correct">${data.correct}</span>, Incorrect: <span class="stat-incorrect">${data.incorrect}</span>)`;
                failedQuestionsList.appendChild(li);
            });
        } else {
            failedQuestionsList.innerHTML = '<li>Aucune question n\'a √©t√© rat√©e. Excellent travail !</li>';
        }
    });

    backToMainMenuFromStatsBtn.addEventListener('click', showMenu);

    // --- LOGIQUE DU TH√àME SOMBRE ---
    function applyTheme(theme) {
        document.body.classList.toggle('dark-mode', theme === 'dark');
        themeToggleBtn.textContent = theme === 'dark' ? 'Th√®me Clair' : 'Th√®me Sombre';
        localStorage.setItem('quizTheme', theme);
    }
    themeToggleBtn.addEventListener('click', () => {
        const currentTheme = localStorage.getItem('quizTheme') || 'light';
        applyTheme(currentTheme === 'light' ? 'dark' : 'light');
    });

    // --- GESTION DES S√âLECTIONS D'OPTIONS DE JEU ---
    gameModeOptions.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            Array.from(gameModeOptions.children).forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');
            selectedGameMode = e.target.dataset.mode;
            loadHighScore(); // Mettre √† jour l'affichage du meilleur score pour la nouvelle s√©lection
        }
    });

    difficultyOptions.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            Array.from(difficultyOptions.children).forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');
            selectedDifficulty = e.target.dataset.difficulty;
            loadHighScore(); // Mettre √† jour l'affichage du meilleur score pour la nouvelle s√©lection
        }
    });

    startFiguresBtn.addEventListener('click', () => selectQuiz('figures'));
    startTonalitesBtn.addEventListener('click', () => selectQuiz('tonalites'));
    startSelectedQuizBtn.addEventListener('click', startQuiz);


    // --- Initialisation de la page ---
    async function initialize() {
        const savedTheme = localStorage.getItem('quizTheme') || 'light';
        applyTheme(savedTheme);
        loadUsers(); // Charger les profils utilisateur
        showMenu();
    }
    
    // √âv√©nements des boutons de profil
    createUserBtn.addEventListener('click', createUser);
    loadUserBtn.addEventListener('click', () => {
        const username = usernameInput.value.trim();
        if (username) {
            loadUser(username);
        } else {
            alert("Veuillez entrer un nom d'utilisateur √† charger.");
        }
    });
    viewStatsBtn.addEventListener('click', displayOverallStats);


    initialize();
</script>
</body>
</html>
